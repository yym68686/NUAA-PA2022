
# 南京航空航天大学《计算机组成原理Ⅱ课程设计》报告

* 姓名：颜宇明
* 班级：1819001
* 学号：161940233
* 报告阶段：PA0
* 完成日期：2022.3.20
* 本次实验，我完成了所有内容。

## 目录
[TOC]

## 思考题

1. Linux and Linux?

    Debian and Ubuntu, even CentOS and Red Hat mentioned above are all different kinds of Linux. What are the common and different points betweent them?  

    共同点：都是Linux的发行版，都是由Linux衍生而来的。

    不同点：有些是由商业公司维护的商业版本，有些版本由开源社区维护的免费发行版本。商业版本以Redhat为代表，开源社区版本则以debian为代表。CentOS是从redhat源代码编译重新发布版。Ubuntu对计算机硬件的支持好于centos和debian，兼容性强，Ubuntu应用非常多。Debian也非常适合做服务器操作系统，与Ubuntu比较，它没有太多的花哨，稳定压倒一切，对于服务器系统来说是一条不变的真理，debian这个linux系统，底层非常稳定，内核和内存的占用都非常小。CentOS的发行会滞后于RedHat的发行，包括关键的补丁和修复。

2. Can't memory be larger?

    Can the size of memory be as large as possible? There's a limitation of 4GB for 32-bit operating systems, why? (Hint: Architecture and addressing)

    32位系统使用32位地址线的最大寻址空间为$$2^{32}$$bytes，计算后即 4294967296 Bytes，也就是我们常说的4096MB，所以32位地址线的寻址空间封顶即为 4GB。

3. Why Windows is quite 'fat'?

    Installing a Windows operating system usually requires much more disk space as well as memory. Can you figure out why the Debian operating system you installed can be so "slim"?

    win有图形界面，通用性好，有大量的依赖，所以占用磁盘大。debian没有图形界面，都是命令行操作，没有多余的软件，定制性比较强，通用性不好，所以磁盘占用小。

4. Why executing the 'poweroff' command requires superuser privilege?

    Can you provide a scene where bad thing will happen if the `poweroff` command does not require superuser privilege?

    任何用户都可以关闭系统，导致服务中断，有可能造成重大损失。

5. What happened?

    You should know how a program is generated in the 程序设计基础 course. But do you have any idea about what happened when a bunch of information is output to the screen during `make` is executed?

    ![image-20220320163834059](..\images\image-20220320163834059.png)

    这时make正在执行：

    ```makefile
    $(OBJ_DIR)/%.o: src/%.c
         @echo + CC $<
         @mkdir -p $(dir $@)
         @$(CC) $(CFLAGS) -c -o $@ $<
    ```

    将.c文件编译为.o文件。

6. How will you do?

    If you were asked to make a simulated computer which can run a `helloworld` program by yourself, how will you do that? This question has no correct answer and you can imagine it as you like. You can answer it in Chinese or English.

    编写编译器识别源代码，形成汇编代码，再通过汇编器形成目标代码，再通过链接器形成可执行程序，存到磁盘里。计算机再通过取指令→分析指令→执行指令→再取下一条指令，　helloworld程序首先被加载，从磁盘中复制到寄存器中，寄存器将helloworld程序复制到主存中进行存储。程序运行过程中，CPU执行helloworld机器指令，指令的结果是将”hello，world”字符由内存复制到寄存器，寄存器再将结果复制到显示设备上显示出来。loworld输出。

## 实验内容

### PA0.1 Installing a GNU/Linux VM

1. 打开 `VMware` ，安装 `Debian 11.2`。
2. 处理器数量为2，每个处理器内核数量为2。
3. 设定虚拟机名称，如我的叫 `PA`，选择操作系统版本为 `其他Linux 5.x及更高版本内核`，然后点击 `Next`；
4. 设定内存大小，我给我的虚拟机设定了 2048MB 的内存；

### PA0.2 First Step into Linux

1. 执行

    ```bash
    df -h
    su
    poweroff
    ```

![image-20220319135641890](../images/image-20220319135641890.png)

### PA0.3 Installing Basic Tools

1. 先执行`su -`，切换到root用户。

2. 执行

    ```bash
    apt-cdrom ident # 扫描安装光盘信息
    apt-cdrom add   # 添加安装做为安装源
    addgroup yanyuming sudo
    exit
    sudo poweroff
    ```

    apt-cdrom命令用于扫描[Debian](https://so.csdn.net/so/search?q=Debian&spm=1001.2101.3001.7020)安装光盘信息,也将安装光盘做为安装源添加到sources.list里。

3. 安装软件：

    ```bash
    sudo apt install sudo
    sudo apt install -y vim openssh-server
    ```

4. 测试

    ```bash
    vim test
    exit
    exit
    sudo poweroff
    ```

### PA0.4 Installing More Tools

1. ```bash
    ping www.baidu.com -c 4
    ```

    网络正常。

2. 修改/etc/apt/source.list：

    ```bash
    deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib
    deb-src http://mirrors.aliyun.com/debian/ bullseye main non-free contrib
    deb http://mirrors.aliyun.com/debian-security/ bullseye-security main
    deb-src http://mirrors.aliyun.com/debian-security/ bullseye-security main
    deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib
    deb-src http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib
    deb http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib
    deb-src http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib
    ```

3. 执行命令：

    ```bash
    sudo apt update
    sudo apt upgrade -y
    sudo apt install -y man build-essential gcc-doc gdb git gcc-multilib libreadline-dev libsdl2-dev qemu-system-x86
    ```

### PA0.5 More Exploration

1. 执行命令：

    ```bash
    cp /etc/vim/vimrc ~/.vimrc
    cd ~
    ls -a
    vim .vimrc
    ```

2. 修改.vimrc：

    ```bash
    noremap <A-Up> <ESC>:m-2<CR>
    inoremap <A-Up> <ESC>:m-2<CR>
    noremap <A-Down> <ESC>:m+1<CR>
    inoremap <A-Down> <ESC>:m+1<CR>
    noremap <M-S-Up> <ESC>yyP
    inoremap <M-S-Up> <ESC>yyP
    noremap <M-S-Down> <ESC>yyp
    inoremap <M-S-Down> <ESC>yyp
    noremap <C-L> <Esc>:tabnext<CR>
    noremap <C-H> <Esc>:tabprevious<CR>
    
    syntax on
    " Tab键的宽度
    set ts=4
    "统一缩进为4
    set softtabstop=4
    set shiftwidth=4
    " 不要用空格代替制表符
    set noexpandtab
    "自动缩进
    set autoindent
    set smartindent " 开启新行时使用智能自动缩进
    "编码设置
    set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936
    set termencoding=utf-8
    set encoding=utf-8
    " 显示行号
    set number
    "自动保存
    set autowrite
    "从不备份 禁止生成临时文件
    set nobackup
    set noswapfile
    
    "让vim的yank默认使用系统剪贴板
    set clipboard=unnamedplus
    
    set showmatch          " Show matching brackets.
    set ignorecase         " Do case insensitive matching
    set smartcase         " Do smart case matching
    set incsearch          " Incremental search
    set background=dark
    set hidden             " Hide buffers when they are abandoned
    set hlsearch " 搜索时高亮显示被找到的文本
    ```

3. 编写hello.c：

    ```c
    #include <stdio.h>
    int main(){
    	printf("Hello, world!\n");
    }
    ```

    执行：

    ```bash
    gcc -o ./hello hello.c
    ./hello
    ```

    ![image-20220319185228930](../images/image-20220319185228930.png)

4. 使用gdb，执行：

    ```bash
    gdb ./hello
    br main
    r
    disas
    c
    q
    ```

    ![image-20220319190152902](../images/image-20220319190152902.png)

5. 执行：

    ```bash
    cd ~
    mkdir helloproject/
    mv hello.c helloproject/
    cd helloproject/
    touch Makefile
    vim Makefile
    ```

    编辑Makefile文件：

    ```makefile
    CC = g++
    SOURCE := hello.c
    build:
    	$(CC) $(SOURCE) -o ./hello
    clean:
    	@rm -f ./hello
    run:
    	./hello
    ```

    ![image-20220319191538369](../images/image-20220319191538369.png)

6. 校准时间：

    ```bash
    sudo apt install ntpdate
    sudo ntpdate ntp.ntsc.ac.cn
    ```

### PA0.6 Logging in and Transferring Files via SSH

1. 用MobaXterm通过ssh登录虚拟机：

    ![image-20220319193213895](../images/image-20220319193213895.png)

2. 在桌面上创建c.sh，拖到MobaXterm中，成功放到虚拟机中：

    ![image-20220319195354443](../images/image-20220319195354443.png)

    修改c.sh的内容，再拖回桌面，发现成功改变内容。

3. Configuring X Server

    - 打开X11-Forwarding，执行命令：

        ```bash
        sudo apt install x11-apps
        xclock
        ```

        ![image-20220320142211170](../images/image-20220320142211170.png)

4. 备份虚拟机
    1. 确保虚拟机电源处于已关闭状态。
    2. 找到虚拟机文件夹。
    3. 右键单击虚拟机文件夹，然后单击**复制**。
    4. 导航到要存储备份的文件夹，右键单击该文件夹中的任意位置，然后单击**粘贴**。

### PA0.7 Acquiring Source Code for PAs

1. 下载代码：

    ```bash
    git clone https://gitee.com/nuaa-pa-2021/ics-pa.git ics2022
    ```

2. 配置git

    ```bash
    git config --global user.email "yym68686@outlook.com"
    git config --global user.name "161940233-yanyuming"
    git config --global core.editor vim
    git config --global color.ui true
    ```

3. 执行命令：

    ```bash
    cd ~/ics2022
    git branch -m master
    bash init.sh
    ```

4. Git Usage

    ```bash
    git branch
    git checkout -b pa0
    # modify STU_ID=161220000
    git status
    git diff
    ```

    ![image-20220320145535366](../images/image-20220320145535366.png)

    ```bash
    git add .
    git commit
    ```

    Type `modified my STU_ID` and save and exit the editor.

    ```bash
    git log
    git checkout master
    ```

5. Compiling and Running NEMU

    ```bash
    cd ~/ics2022/nemu
    make
    make clean
    make
    make run
    make gdb
    ```

    ![image-20220320151617511](../images/image-20220320151617511.png)

    ```bash
    git log
    git add .
    git commit --allow-empty
    git log --author 161940233-yanyuming
    make submit
    # 在主机上查看文件完整
    
    git remote add myrepo https://github.com/yym68686/NUAA-PA2022.git
    git push -u myrepo master
    ```

## 遇到的问题及解决办法

1. 遇到问题：git push 报错 fatal: unable to access 'https://github.com/yym68686/NUAA-PA2022.git/': Could not resolve host: github.com

    解决方案：添加host：

    ```bash
    echo '140.82.113.3 github.com' >> /etc/hosts
    ```

2. 遇到问题：Debian11软件更新出错。

    解决方案：把Debian10的源更新为Debian11的源。

## Debain从0安装到运行成功

[0.1 Installing a GNU/Linux VM](https://zhong-kangwei.gitee.io/ics-pa-gitbook-2022/pa0/0.1.html)

重启

```bash
su
apt-cdrom ident
apt-cdrom add
addgroup yanyuming sudo
apt install -y vim openssh-server sudo
```

[debian镜像-debian下载地址-debian安装教程-阿里巴巴开源镜像站](https://developer.aliyun.com/mirror/debian?spm=a2c6h.13651102.0.0.3cc61b110xBBK2)

```bash
sudo apt update
sudo apt upgrade -y
sudo apt install -y man build-essential gcc-doc gdb git gcc-multilib libreadline-dev libsdl2-dev qemu-system-x86 x11-apps
```

下载：

```
git clone -b pa1 https://github.com/yym68686/ics2022.git
```

新的git环境需要以下命令初始化：

```bash
cd ~
git config --global user.email "yym68686@outlook.com"
git config --global user.name "161940233-yanyuming"
git config --global http.proxy <http://192.168.60.1:7890>
git config --global https.proxy <https://192.168.60.1:7890>
touch ~/.netrc && chmod 600 ~/.netrc && echo -e 'machine github.com\\n        login not-used\\n        password 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' > ~/.netrc
git clone <https://github.com/yym68686/ics2022.git>
cd ics2022
git checkout -b pa2 remotes/origin/pa2
git remote rm origin
git remote add myrepo <https://github.com/yym68686/ics2022.git>
./init.sh
echo alias ll="ls -al" >> ~/.bashrc
source ~/.bashrc
clear && cd ~/ics2022/nexus-am/tests/cputest && make clean && make ARCH=x86-nemu ALL=dummy run
```